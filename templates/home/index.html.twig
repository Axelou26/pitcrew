{% extends 'base.html.twig' %}

{% block title %}Accueil{% endblock %}

{% block body %}
   
    <!-- Posts Section -->
    <section class="py-4">
        <div class="container">
            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8 mb-4">
                    {% if app.user %}
                        <!-- Create Post Card -->
                        <div class="card shadow-sm hover-shadow-md mb-4 rounded-4 border-0">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <a href="{{ path('app_user_profile', {'id': app.user.id}) }}" class="flex-shrink-0">
                                        {% if app.user.profilePicture %}
                                            <img src="{{ asset('uploads/profile_pictures/' ~ app.user.profilePicture) }}" 
                                                 class="rounded-circle border"
                                                 alt="{{ app.user.fullName }}"
                                                 style="width: 48px; height: 48px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                                                 style="width: 48px; height: 48px;">
                                                <i class="bi bi-person text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </a>
                                    <div class="flex-grow-1 position-relative">
                                        <input type="text" id="quick-post-content" class="form-control form-control-lg text-start py-3 bg-light border-0 rounded-pill mention-input" 
                                               placeholder="Quoi de neuf, {{ app.user.firstName }} ?" style="height: auto;">
                                        <div id="mention-suggestions" class="mention-suggestions dropdown-menu"></div>
                                    </div>
                                </div>
                                
                                <div id="quick-post-form" class="d-none">
                                    <div class="mb-3">
                                        <input type="text" id="quick-post-title" class="form-control" placeholder="Titre (optionnel)">
                                    </div>
                                    <div class="mb-3">
                                        <textarea id="quick-post-full-content" class="form-control mention-input" rows="3" placeholder="Contenu de votre publication..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <input type="file" id="quick-post-image" class="form-control" accept="image/*">
                                            <label class="input-group-text" for="quick-post-image">Image</label>
                                        </div>
                                        <small class="form-text text-muted">Formats acceptés : JPEG, PNG, GIF. Taille maximale : 5 Mo.</small>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button type="button" id="quick-post-cancel" class="btn btn-outline-secondary">
                                            <i class="bi bi-x me-1"></i> Annuler
                                        </button>
                                        <button type="button" id="quick-post-submit" class="btn btn-primary">
                                            <i class="bi bi-send me-1"></i> Publier
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Bar -->
                        <div class="d-flex align-items-center mb-4 bg-white p-3 rounded-4 shadow-sm border-0">
                            <div class="dropdown">
                                <button class="btn btn-light rounded-pill dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-funnel me-2"></i>Trier par
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item active" href="#"><i class="bi bi-clock me-2"></i>Les plus récents</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-star me-2"></i>Les plus populaires</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-graph-up me-2"></i>Tendances</a></li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="mb-4">
                            <h2 class="display-6 fw-bold mb-3">Dernières publications</h2>
                            <p class="text-muted lead">Découvrez les actualités de notre communauté F1</p>
                        </div>
                    {% endif %}
                    
                    {% if posts is empty %}
                        <div class="card shadow-sm rounded-4 border-0 p-5 text-center">
                            <i class="bi bi-newspaper display-1 text-primary opacity-50 mb-4"></i>
                            <h3 class="h4 fw-bold mb-3">Aucune publication disponible</h3>
                            <p class="text-muted mb-4">Soyez le premier à partager du contenu avec la communauté</p>
                            {% if app.user %}
                                <div class="text-center">
                                    <a href="{{ path('app_post_new') }}" class="btn btn-primary btn-lg rounded-pill px-5">
                                        <i class="bi bi-plus-lg me-2"></i>Créer une publication
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        {% for post in posts %}
                            {% set isSharedPost = false %}
                            {% set sharingUser = null %}
                            {% set originalPost = post %}
                            
                            {% if post.shares|length > 0 %}
                                {% for share in post.shares %}
                                    {% if sharingUser is null and share.createdAt > post.createdAt %}
                                        {% set isSharedPost = true %}
                                        {% set sharingUser = share.user %}
                                        {% set shareComment = share.comment %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            <div class="card border-0 shadow-sm rounded-3 mb-3">
                                <!-- Post Header -->
                                <div class="card-header bg-white border-0 pt-3 pb-0">
                                    <div class="d-flex">
                                        <a href="{{ path('app_user_profile', {'id': isSharedPost ? sharingUser.id : post.author.id}) }}" class="me-2">
                                            {% if isSharedPost and sharingUser.profilePicture %}
                                                <img src="{{ asset('uploads/profile_pictures/' ~ sharingUser.profilePicture) }}" 
                                                     class="rounded-circle border"
                                                     alt="{{ sharingUser.fullName }}"
                                                     style="width: 48px; height: 48px; object-fit: cover;">
                                            {% elseif post.author.profilePicture %}
                                                <img src="{{ asset('uploads/profile_pictures/' ~ post.author.profilePicture) }}" 
                                                     class="rounded-circle border"
                                                     alt="{{ post.author.fullName }}"
                                                     style="width: 48px; height: 48px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                                                     style="width: 48px; height: 48px;">
                                                    <i class="bi bi-person text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </a>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <a href="{{ path('app_user_profile', {'id': isSharedPost ? sharingUser.id : post.author.id}) }}" class="text-decoration-none text-dark">
                                                    <h6 class="mb-0 fw-bold">{{ isSharedPost ? sharingUser.fullName : post.author.fullName }}</h6>
                                                </a>
                                                {% if isSharedPost %}
                                                    <span class="text-muted ms-2">a republié ceci</span>
                                                {% endif %}
                                                <div class="dropdown ms-auto">
                                                    <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item" href="#"><i class="bi bi-bookmark me-2"></i>Enregistrer</a></li>
                                                        <li><a class="dropdown-item" href="#"><i class="bi bi-link-45deg me-2"></i>Copier le lien</a></li>
                                                        {% if post.author == app.user %}
                                                            <li><a class="dropdown-item" href="{{ path('app_post_edit', {'id': post.id}) }}"><i class="bi bi-pencil me-2"></i>Modifier</a></li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="text-muted small">
                                                {% if isSharedPost and sharingUser.company %}
                                                    {{ sharingUser.company }} • 
                                                {% elseif post.author.company %}
                                                    {{ post.author.company }} • 
                                                {% endif %}
                                                {{ isSharedPost ? 'Republié le ' : '' }}{{ post.createdAt|date('d/m/Y à H:i') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Post Content -->
                                <div class="card-body pt-2">
                                    {% if isSharedPost and shareComment is defined and shareComment %}
                                        <p class="card-text mb-3">{{ shareComment }}</p>
                                    {% endif %}
                                    
                                    {% if isSharedPost %}
                                        <div class="border rounded p-3 mb-3">
                                            <div class="d-flex mb-2">
                                                <a href="{{ path('app_user_profile', {'id': post.author.id}) }}" class="me-2">
                                                    {% if post.author.profilePicture %}
                                                        <img src="{{ asset('uploads/profile_pictures/' ~ post.author.profilePicture) }}" 
                                                             class="rounded-circle border"
                                                             alt="{{ post.author.fullName }}"
                                                             style="width: 32px; height: 32px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                                                             style="width: 32px; height: 32px;">
                                                            <i class="bi bi-person text-muted small"></i>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                                <div>
                                                    <div class="d-flex align-items-center">
                                                        <a href="{{ path('app_user_profile', {'id': post.author.id}) }}" class="text-decoration-none text-dark">
                                                            <h6 class="mb-0 fw-bold">{{ post.author.fullName }}</h6>
                                                        </a>
                                                    </div>
                                                    <div class="text-muted small">
                                                        {% if post.author.company %}{{ post.author.company }} • {% endif %}
                                                        {{ post.createdAt|date('d/m/Y à H:i') }}
                                                    </div>
                                                </div>
                                            </div>
                                    {% endif %}
                                    
                                    {% if post.title %}
                                        <h5 class="card-title fw-bold mb-2">{{ post.title }}</h5>
                                    {% endif %}
                                    
                                    {% set content = post.content %}
                                    
                                    {# Traitement des mentions #}
                                    {% set contentWithMentions = content %}
                                    {% for mention in post.extractMentions %}
                                        {% set mentionKey = '@' ~ mention %}
                                        {% set mentionLink = '<a href="' ~ path('app_user_profile', {'id': mention}) ~ '" class="mention">@' ~ mention ~ '</a>' %}
                                        {% set contentWithMentions = contentWithMentions|replace({(mentionKey): mentionLink}) %}
                                    {% endfor %}
                                    
                                    {# Traitement des hashtags #}
                                    {% set contentWithHashtags = contentWithMentions %}
                                    {% for hashtag in post.extractHashtags %}
                                        {% set hashtagKey = '#' ~ hashtag %}
                                        {% set hashtagLink = '<a href="' ~ path('app_hashtag_show', {'name': hashtag}) ~ '" class="hashtag">#' ~ hashtag ~ '</a>' %}
                                        {% set contentWithHashtags = contentWithHashtags|replace({(hashtagKey): hashtagLink}) %}
                                    {% endfor %}
                                    
                                    <p class="card-text mb-3">
                                        {% if contentWithHashtags|length > 280 %}
                                            {{ contentWithHashtags|slice(0, 280)|raw }}...
                                            <a href="{{ path('app_post_show', {'id': post.id}) }}" class="text-decoration-none">voir plus</a>
                                        {% else %}
                                            {{ contentWithHashtags|raw }}
                                        {% endif %}
                                    </p>
                                    
                                    {% if post.hashtags.count > 0 %}
                                        <div class="hashtags-container mb-3">
                                            {% for hashtag in post.hashtags %}
                                                <a href="{{ path('app_hashtag_show', {'name': hashtag.name}) }}" class="badge bg-light text-dark text-decoration-none">
                                                    {{ hashtag.formattedName }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if post.image %}
                                        <div class="post-image mb-3">
                                            <img src="{{ asset('uploads/posts/' ~ post.image) }}" 
                                                 class="img-fluid rounded-3" 
                                                 alt="{{ post.title }}" 
                                                 style="width: 100%; max-height: 500px; object-fit: cover;">
                                        </div>
                                    {% endif %}
                                    
                                    {% if isSharedPost %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Post Stats -->
                                    <div class="d-flex align-items-center text-muted small mb-2">
                                        <div class="me-auto">
                                            {% set totalReactions = post.likesCount %}
                                            {% if totalReactions > 0 %}
                                                <div class="d-flex align-items-center">
                                                    <div class="reaction-icons">
                                                        {% set displayedReactions = 0 %}
                                                        {% for reactionType, count in post.reactionCounts %}
                                                            {% if count > 0 and displayedReactions < 3 %}
                                                                <span class="reaction-icon" title="{{ ('reactions.' ~ reactionType)|trans }}">
                                                                    {% if reactionType == 'like' %}👍{% endif %}
                                                                    {% if reactionType == 'congrats' %}👏{% endif %}
                                                                    {% if reactionType == 'interesting' %}💡{% endif %}
                                                                    {% if reactionType == 'support' %}❤️{% endif %}
                                                                    {% if reactionType == 'encouraging' %}💪{% endif %}
                                                                </span>
                                                                {% set displayedReactions = displayedReactions + 1 %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <span class="ms-1">{{ totalReactions }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if post.commentsCount > 0 %}
                                            <span>{{ post.commentsCount }} commentaire{% if post.commentsCount > 1 %}s{% endif %}</span>
                                        {% endif %}
                                        {% if post.sharesCount > 0 %}
                                            <span class="ms-2">{{ post.sharesCount }} republication{% if post.sharesCount > 1 %}s{% endif %}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Post Actions -->
                                    <div class="d-flex align-items-center gap-4 py-2">
                                        <div class="reaction-container position-relative">
                                            <button class="btn btn-light rounded-pill px-3 d-flex align-items-center gap-2 btn-like" data-post-id="{{ post.id }}">
                                                <i class="bi {% if app.user and post.isLikedByUser(app.user) %}
                                                    {% if post.getUserReaction(app.user) == 'like' %}bi-hand-thumbs-up-fill text-primary{% endif %}
                                                    {% if post.getUserReaction(app.user) == 'congrats' %}bi-emoji-smile-fill text-warning{% endif %}
                                                    {% if post.getUserReaction(app.user) == 'interesting' %}bi-lightbulb-fill text-warning{% endif %}
                                                    {% if post.getUserReaction(app.user) == 'support' %}bi-heart-fill text-danger{% endif %}
                                                    {% if post.getUserReaction(app.user) == 'encouraging' %}bi-hand-thumbs-up-fill text-success{% endif %}
                                                    {% else %}bi-hand-thumbs-up{% endif %}"></i>
                                                <span class="like-count">{{ post.likesCount }}</span>
                                            </button>
                                            <div class="reactions-box position-absolute bg-white shadow rounded-pill p-1 d-none">
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-reaction p-1" data-post-id="{{ post.id }}" data-reaction="like" title="J'aime">
                                                        <i class="bi bi-hand-thumbs-up-fill text-primary fs-5"></i>
                                                    </button>
                                                    <button class="btn btn-reaction p-1" data-post-id="{{ post.id }}" data-reaction="congrats" title="Félicitations">
                                                        <i class="bi bi-emoji-smile-fill text-warning fs-5"></i>
                                                    </button>
                                                    <button class="btn btn-reaction p-1" data-post-id="{{ post.id }}" data-reaction="interesting" title="Intéressant">
                                                        <i class="bi bi-lightbulb-fill text-warning fs-5"></i>
                                                    </button>
                                                    <button class="btn btn-reaction p-1" data-post-id="{{ post.id }}" data-reaction="support" title="Soutien">
                                                        <i class="bi bi-heart-fill text-danger fs-5"></i>
                                                    </button>
                                                    <button class="btn btn-reaction p-1" data-post-id="{{ post.id }}" data-reaction="encouraging" title="Encourageant">
                                                        <i class="bi bi-hand-thumbs-up-fill text-success fs-5"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-light rounded-pill px-3 d-flex align-items-center gap-2 btn-comment" data-post-id="{{ post.id }}">
                                            <i class="bi bi-chat"></i>
                                            <span>{{ post.commentsCount }}</span>
                                        </button>
                                        <a href="{{ path('app_post_share', {'id': post.id}) }}" class="btn btn-light rounded-pill px-3 d-flex align-items-center gap-2">
                                            <i class="bi bi-share"></i>
                                            <span>Republier</span>
                                        </a>
                                    </div>
                                    
                                    <!-- Comments Section (hidden by default) -->
                                    <div class="comments-section mt-3 p-3 bg-light rounded-4 d-none" id="comments-section-{{ post.id }}">
                                        <h6 class="fw-bold mb-3">Commentaires</h6>
                                        
                                        <!-- Comments List -->
                                        <div class="comments-list mb-3" id="comments-list-{{ post.id }}">
                                            <!-- Comments will be loaded here via AJAX -->
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Chargement...</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Comment Form -->
                                        {% if app.user %}
                                            <div class="d-flex gap-2 mt-3">
                                                <div class="flex-shrink-0">
                                                    {% if app.user.profilePicture %}
                                                        <img src="{{ asset('uploads/profile_pictures/' ~ app.user.profilePicture) }}" 
                                                             class="rounded-circle border"
                                                             alt="{{ app.user.fullName }}"
                                                             style="width: 32px; height: 32px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center border"
                                                             style="width: 32px; height: 32px;">
                                                            <i class="bi bi-person text-muted small"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <form class="comment-form" data-post-id="{{ post.id }}">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control form-control-sm rounded-pill-start" 
                                                                   placeholder="Ajouter un commentaire..." required>
                                                            <button type="submit" class="btn btn-primary btn-sm rounded-pill-end">
                                                                <i class="bi bi-send"></i>
                                        </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        {% else %}
                                            <p class="text-muted small">
                                                <a href="{{ path('app_login') }}">Connectez-vous</a> pour commenter
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Profile Card -->
                    {% if app.user %}
                        <div class="card shadow-sm rounded-4 border-0 mb-4">
                            <div class="card-body p-4">
                                <div class="text-center mb-4">
                                    {% if app.user.profilePicture %}
                                        <img src="{{ asset('uploads/profile_pictures/' ~ app.user.profilePicture) }}" 
                                             class="rounded-circle border mb-3"
                                             alt="{{ app.user.fullName }}"
                                             style="width: 96px; height: 96px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto border mb-3"
                                             style="width: 96px; height: 96px;">
                                            <i class="bi bi-person fs-2 text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <h5 class="fw-bold mb-1">{{ app.user.fullName }}</h5>
                                    <p class="text-muted mb-3">
                                    {% if app.user.isRecruiter %}
                                        {{ app.user.company }}
                                    {% else %}
                                        {{ app.user.jobTitle|default('') }}
                                    {% endif %}
                                </p>
                                
                                    <a href="{{ path('app_user_profile', {'id': app.user.id}) }}" class="btn btn-primary rounded-pill w-100">
                                        <i class="bi bi-person-circle me-2"></i>Voir mon profil
                                    </a>
                                </div>
                                
                                <div class="row g-2 text-center">
                                    <div class="col-4">
                                        <div class="p-3 rounded-4 bg-light">
                                            <h6 class="fw-bold mb-1">{{ app.user.posts|length }}</h6>
                                            <small class="text-muted">Publications</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 rounded-4 bg-light">
                                            <h6 class="fw-bold mb-1">
                                                {% if app.user.isRecruiter %}
                                                    0
                                                {% else %}
                                                    {{ app.user.friends|default([])|length }}
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">Amis</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 rounded-4 bg-light">
                                            <h6 class="fw-bold mb-1">
                                                {% if app.user.isRecruiter %}
                                                    {{ app.user.jobOffers|default([])|length }}
                                                {% else %}
                                                    {{ app.user.posts|length }}
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">
                                                {% if app.user.isRecruiter %}
                                                    Offres
                                                {% else %}
                                                    Publications
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Suggestions -->
                    {% if suggestedUsers|length > 0 %}
                        <div class="card shadow-sm rounded-4 border-0 mb-4">
                            <div class="card-body p-4">
                                <h6 class="fw-bold mb-3">Personnes que vous pourriez connaître</h6>
                                {% for user in suggestedUsers|slice(0, 5) %}
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                            <div class="d-flex align-items-center">
                                            <a href="{{ path('app_user_profile', {'id': user.id}) }}" class="me-2">
                                                {% if user.profilePicture %}
                                                    <img src="{{ asset('uploads/profile_pictures/' ~ user.profilePicture) }}" 
                                                             class="rounded-circle border"
                                                         alt="{{ user.fullName }}"
                                                             style="width: 40px; height: 40px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                                                             style="width: 40px; height: 40px;">
                                                            <i class="bi bi-person text-muted"></i>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                            <div>
                                                <h6 class="mb-0 fw-semibold">
                                                    <a href="{{ path('app_user_profile', {'id': user.id}) }}" class="text-dark text-decoration-none">
                                                        {{ user.fullName }}
                                                    </a>
                                                </h6>
                                                <small class="text-muted">{{ user.jobTitle|default(user.company) }}</small>
                                                    </div>
                                                </div>
                                                {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                                            {% if user.isFriend is defined and user.isFriend %}
                                                <button class="btn btn-light btn-sm rounded-pill px-3" disabled>
                                                    <i class="bi bi-person-check me-1"></i>Ami
                                                        </button>
                                            {% elseif user.hasPendingRequestFrom is defined and user.hasPendingRequestFrom %}
                                                <button class="btn btn-light btn-sm rounded-pill px-3" disabled>
                                                    <i class="bi bi-hourglass-split me-1"></i>En attente
                                                        </button>
                                                    {% else %}
                                                <a href="{{ path('app_friendship_send', {'id': user.id}) }}" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                                    <i class="bi bi-person-plus me-1"></i>Ajouter
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                    {% endfor %}
                                {% if suggestedUsers|length > 5 %}
                                    <a href="{{ path('app_user_suggestions') }}" class="btn btn-light rounded-pill w-100">
                                        Voir plus
                                    </a>
                                {% endif %}
                            </div>
                                </div>
                            {% endif %}
                    
                    <!-- Trending Hashtags -->
                    <div class="card shadow-sm rounded-4 border-0 mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold mb-0">Sujets tendance</h6>
                                <a href="{{ path('app_hashtags_trending') }}" class="text-decoration-none small">
                                    Voir plus
                                </a>
                            </div>
                            
                            {% if trendingHashtags is defined and trendingHashtags|length > 0 %}
                                {% for hashtag in trendingHashtags|slice(0, 5) %}
                                    <a href="{{ path('app_hashtag_show', {'name': hashtag.name}) }}" class="text-decoration-none">
                                        <div class="rounded-3 p-3 mb-2 hover-bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="fw-bold text-primary">#{{ hashtag.name }}</div>
                                                    <div class="text-muted small">{{ hashtag.usageCount }} publications</div>
                                                </div>
                                                <i class="bi bi-hash fs-4 text-muted"></i>
                                            </div>
                                        </div>
                                    </a>
                                {% endfor %}
                            {% else %}
                                <div class="text-center p-3">
                                    <i class="bi bi-hash-lg text-muted fs-1 mb-2"></i>
                                    <p class="text-muted">Aucun hashtag tendance pour le moment</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Stats Section -->
                    <div class="card shadow-sm rounded-4 border-0 bg-primary text-white">
                        <div class="card-body p-4">
                            <h6 class="fw-bold mb-4">PitCrew en chiffres</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="bg-white bg-opacity-10 rounded-4 p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-2 me-3">
                                                <i class="bi bi-briefcase text-primary"></i>
                                            </div>
                                            <div>
                                                <h3 class="h5 fw-bold mb-0">{{ offers|length }}+</h3>
                                                <small class="text-white-50">Offres d'emploi</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="bg-white bg-opacity-10 rounded-4 p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-2 me-3">
                                                <i class="bi bi-building text-primary"></i>
                                            </div>
                                            <div>
                                                <h3 class="h5 fw-bold mb-0">{{ recruiters|length }}+</h3>
                                                <small class="text-white-50">Entreprises</small>
                                            </div>
                                        </div>
                                    </div>
                </div>
                                <div class="col-12">
                                    <div class="bg-white bg-opacity-10 rounded-4 p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-2 me-3">
                                                <i class="bi bi-people text-primary"></i>
                        </div>
                                            <div>
                                                <h3 class="h5 fw-bold mb-0">{{ applicants|length }}+</h3>
                                                <small class="text-white-50">Candidats</small>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .hover-shadow-md {
            transition: box-shadow 0.3s ease;
        }
        
        .hover-shadow-md:hover {
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.1)!important;
        }
        
        .hover-primary:hover {
            color: var(--bs-primary);
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        
        .hover-success:hover {
            color: var(--bs-success);
            background-color: rgba(var(--bs-success-rgb), 0.1);
        }
        
        .hover-danger:hover {
            color: var(--bs-danger);
            background-color: rgba(var(--bs-danger-rgb), 0.1);
        }
        
        .btn-light {
            background-color: var(--bs-light);
            border-color: var(--bs-light);
        }
        
        .bg-light {
            background-color: var(--bs-light)!important;
        }
        
        /* Styles pour les réactions */
        .reaction-container {
            position: relative;
        }
        
        .reactions-box {
            position: absolute;
            bottom: 50px;
            left: 0;
            z-index: 100;
            transition: all 0.2s ease;
            transform-origin: bottom left;
            padding: 8px !important;
        }
        
        .btn-reaction {
            transition: transform 0.3s ease;
            background: transparent;
            border: none;
            padding: 10px !important;
            margin: 0 3px;
        }
        
        .btn-reaction i {
            font-size: 1.4rem !important;
        }
        
        .btn-reaction:hover {
            transform: scale(1.3);
            background: transparent;
        }
        
        .btn-reaction:focus, .btn-reaction:active {
            box-shadow: none;
            outline: none;
            background: transparent;
        }
        
        .reaction-text {
            font-size: 0.8rem;
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .btn-reaction:hover .reaction-text {
            opacity: 1;
        }
        
        /* Style pour les hashtags tendance */
        .hover-bg-light {
            transition: background-color 0.2s ease;
        }
        
        .hover-bg-light:hover {
            background-color: var(--bs-light);
        }
        
        .mention-suggestions {
            position: absolute;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1050;
            display: none;
        }
        
        .mention-suggestions.show {
            display: block;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            background-color: white;
        }
        
        .mention-item:hover, .mention-item.active {
            background-color: #f8f9fa;
        }
        
        .mention-item img, .mention-item .avatar-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .mention-item .avatar-placeholder {
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mention {
            color: #0d6efd;
            font-weight: 500;
        }
        
        .hashtag {
            color: #0d6efd;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion de la création rapide de post
            const quickPostContent = document.getElementById('quick-post-content');
            const quickPostForm = document.getElementById('quick-post-form');
            const quickPostTitle = document.getElementById('quick-post-title');
            const quickPostFullContent = document.getElementById('quick-post-full-content');
            const quickPostCancel = document.getElementById('quick-post-cancel');
            const quickPostSubmit = document.getElementById('quick-post-submit');
            const quickPostImage = document.getElementById('quick-post-image');
            
            if (quickPostContent) {
                quickPostContent.addEventListener('focus', function() {
                    quickPostForm.classList.remove('d-none');
                    quickPostFullContent.focus();
                    quickPostFullContent.value = quickPostContent.value;
                });
                
                quickPostCancel.addEventListener('click', function() {
                    quickPostForm.classList.add('d-none');
                    quickPostContent.value = '';
                    quickPostTitle.value = '';
                    quickPostFullContent.value = '';
                    quickPostImage.value = '';
                });
                
                quickPostSubmit.addEventListener('click', function() {
                    const formData = new FormData();
                    formData.append('title', quickPostTitle.value);
                    formData.append('content', quickPostFullContent.value);
                    
                    if (quickPostImage.files.length > 0) {
                        formData.append('imageFile', quickPostImage.files[0]);
                    }
                    
                    // Désactiver le bouton et montrer un indicateur de chargement
                    quickPostSubmit.disabled = true;
                    quickPostSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publication en cours...';
                    
                    fetch('/post/quick-create', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Rediriger vers la page d'accueil ou recharger pour voir le nouveau post
                            window.location.reload();
                        } else {
                            // Afficher l'erreur
                            alert(data.error || 'Une erreur est survenue lors de la publication. Veuillez réessayer.');
                            // Réactiver le bouton
                            quickPostSubmit.disabled = false;
                            quickPostSubmit.innerHTML = '<i class="bi bi-send me-1"></i> Publier';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        // Réactiver le bouton et afficher un message d'erreur
                        quickPostSubmit.disabled = false;
                        quickPostSubmit.innerHTML = '<i class="bi bi-send me-1"></i> Publier';
                        alert('Une erreur est survenue lors de la publication. Veuillez réessayer.');
                    });
                });
            }
            
            // Fonctionnalité d'autocomplétion des mentions
            const mentionInputs = document.querySelectorAll('.mention-input');
            const mentionSuggestions = document.getElementById('mention-suggestions');
            
            if (mentionInputs.length > 0 && mentionSuggestions) {
                let currentMentionInput = null;
                let mentionPos = -1;
                let mentionText = '';
                let atPos = -1;
                let isMentioning = false;
                
                // Fonction pour détecter la position du curseur
                function getCaretPosition(element) {
                    return element.selectionStart;
                }
                
                // Fonction pour extraire le texte de la mention en cours
                function extractMentionText(text, cursorPos) {
                    const beforeCursor = text.substring(0, cursorPos);
                    const atIndex = beforeCursor.lastIndexOf('@');
                    
                    if (atIndex !== -1) {
                        const afterAt = beforeCursor.substring(atIndex + 1);
                        // Vérifier qu'il n'y a pas d'espace dans le texte après @
                        if (!/\s/.test(afterAt)) {
                            return {
                                text: afterAt,
                                startPos: atIndex
                            };
                        }
                    }
                    
                    return null;
                }
                
                // Fonction pour insérer la mention à la position du curseur
                function insertMention(username, userId, fullName) {
                    const initialText = currentMentionInput.value;
                    const cursorPos = getCaretPosition(currentMentionInput);
                    const mention = `@${username} `;
                    
                    const newText = initialText.substring(0, atPos) + mention + initialText.substring(cursorPos);
                    currentMentionInput.value = newText;
                    
                    // Placer le curseur après la mention insérée
                    currentMentionInput.selectionStart = atPos + mention.length;
                    currentMentionInput.selectionEnd = atPos + mention.length;
                    currentMentionInput.focus();
                    
                    // Masquer les suggestions
                    hideSuggestions();
                }
                
                // Fonction pour rechercher des utilisateurs
                function searchUsers(query) {
                    if (query.length < 2) {
                        hideSuggestions();
                        return;
                    }
                    
                    fetch(`/user/search?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            renderSuggestions(data.users);
                        })
                        .catch(error => {
                            console.error('Erreur lors de la recherche d\'utilisateurs:', error);
                            hideSuggestions();
                        });
                }
                
                // Fonction pour afficher les suggestions
                function renderSuggestions(users) {
                    if (!users || users.length === 0) {
                        hideSuggestions();
                        return;
                    }
                    
                    // Positionner les suggestions sous l'input actuel
                    if (currentMentionInput) {
                        const inputRect = currentMentionInput.getBoundingClientRect();
                        mentionSuggestions.style.top = `${inputRect.bottom}px`;
                        mentionSuggestions.style.left = `${inputRect.left}px`;
                        mentionSuggestions.style.width = `${inputRect.width}px`;
                    }
                    
                    // Vider et afficher la liste des suggestions
                    mentionSuggestions.innerHTML = '';
                    mentionSuggestions.classList.add('show');
                    
                    users.forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'mention-item';
                        
                        let avatarHtml = '';
                        if (user.profilePicture) {
                            avatarHtml = `<img src="/uploads/profile_pictures/${user.profilePicture}" alt="${user.fullName}">`;
                        } else {
                            avatarHtml = `<div class="avatar-placeholder"><i class="bi bi-person-circle"></i></div>`;
                        }
                        
                        item.innerHTML = `
                            ${avatarHtml}
                            <div>
                                <div>${user.fullName}</div>
                                <small class="text-muted">@${user.username}</small>
                            </div>
                        `;
                        
                        item.addEventListener('click', function() {
                            insertMention(user.username, user.id, user.fullName);
                        });
                        
                        mentionSuggestions.appendChild(item);
                    });
                }
                
                // Fonction pour masquer les suggestions
                function hideSuggestions() {
                    mentionSuggestions.classList.remove('show');
                    mentionSuggestions.innerHTML = '';
                    isMentioning = false;
                }
                
                // Ajout des gestionnaires d'événements à tous les inputs
                mentionInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        currentMentionInput = input;
                        const cursorPos = getCaretPosition(input);
                        const mentionData = extractMentionText(input.value, cursorPos);
                        
                        if (mentionData) {
                            mentionText = mentionData.text;
                            atPos = mentionData.startPos;
                            isMentioning = true;
                            searchUsers(mentionText);
                        } else {
                            hideSuggestions();
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        // Si la liste des suggestions est affichée
                        if (mentionSuggestions.classList.contains('show')) {
                            currentMentionInput = input;
                            const items = mentionSuggestions.querySelectorAll('.mention-item');
                            
                            if (e.key === 'ArrowDown') {
                                e.preventDefault();
                                mentionPos = (mentionPos + 1) % items.length;
                                highlightItem(items, mentionPos);
                            } else if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                mentionPos = (mentionPos - 1 + items.length) % items.length;
                                highlightItem(items, mentionPos);
                            } else if (e.key === 'Enter' && mentionPos >= 0) {
                                e.preventDefault();
                                items[mentionPos].click();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                hideSuggestions();
                            }
                        }
                    });
                });
                
                // Fonction pour mettre en surbrillance un élément
                function highlightItem(items, pos) {
                    items.forEach((item, index) => {
                        if (index === pos) {
                            item.classList.add('active');
                            } else {
                            item.classList.remove('active');
                        }
                    });
                }
                
                // Masquer les suggestions lorsque l'utilisateur clique en dehors
                document.addEventListener('click', function(e) {
                    let isClickInside = false;
                    mentionInputs.forEach(input => {
                        if (input.contains(e.target)) {
                            isClickInside = true;
                        }
                    });
                    
                    if (!mentionSuggestions.contains(e.target) && !isClickInside) {
                        hideSuggestions();
                    }
                });
            }
            
            // Gestion des commentaires
            document.querySelectorAll('.btn-comment').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const commentsSection = document.getElementById('comments-section-' + postId);
                    
                    if (commentsSection.classList.contains('d-none')) {
                        // Show comments section
                        commentsSection.classList.remove('d-none');
                        
                        // Load comments
                        loadComments(postId);
                    } else {
                        // Hide comments section
                        commentsSection.classList.add('d-none');
                    }
                });
            });
            
            // Fonction pour mettre à jour les statistiques du post
            function updatePostStats(postId, type, count) {
                // Mettre à jour le compteur dans la section des statistiques du post
                const postCard = document.querySelector(`.btn-like[data-post-id="${postId}"]`).closest('.card');
                
                if (type === 'likes') {
                    // Si le compteur est à 0, masquer complètement l'élément
                    const reactionStats = postCard.querySelector('.reaction-icons');
                    if (reactionStats) {
                        const container = reactionStats.closest('.d-flex');
                        if (parseInt(count) === 0) {
                            container.style.display = 'none';
                        } else {
                            container.style.display = '';
                            const countElement = container.querySelector('span.ms-1');
                            if (countElement) {
                                countElement.textContent = count;
                            }
                        }
                    }
                } else if (type === 'comments') {
                    // Mettre à jour le compteur de commentaires dans les statistiques
                    const commentStats = postCard.querySelector('.text-muted.small.mb-2 span:nth-child(2)');
                    if (commentStats) {
                        commentStats.textContent = count + ' commentaire' + (count > 1 ? 's' : '');
                    }
                }
            }
            
            // Load comments via AJAX
            function loadComments(postId) {
                const commentsList = document.getElementById('comments-list-' + postId);
                
                fetch('/post/' + postId + '/comments', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear loading spinner
                        commentsList.innerHTML = '';
                        
                        if (data.comments.length === 0) {
                            commentsList.innerHTML = '<p class="text-muted small">Aucun commentaire pour le moment.</p>';
                            return;
                        }
                        
                        // Render comments
                        data.comments.forEach(comment => {
                            const commentElement = document.createElement('div');
                            commentElement.className = 'comment d-flex gap-2 mb-2';
                            
                            let profileImg = '';
                            if (comment.authorProfilePicture) {
                                profileImg = `<img src="/uploads/profile_pictures/${comment.authorProfilePicture}" 
                                              class="rounded-circle border" 
                                              alt="${comment.authorName}" 
                                              style="width: 32px; height: 32px; object-fit: cover;">`;
                            } else {
                                profileImg = `<div class="bg-white rounded-circle d-flex align-items-center justify-content-center border"
                                              style="width: 32px; height: 32px;">
                                                <i class="bi bi-person text-muted small"></i>
                                             </div>`;
                            }
                            
                            commentElement.innerHTML = `
                                <div class="flex-shrink-0">
                                    ${profileImg}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="bg-white p-2 rounded-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="/user/${comment.authorId}" class="fw-semibold text-decoration-none text-dark small">
                                                ${comment.authorName}
                                            </a>
                                            <small class="text-muted">${comment.createdAt}</small>
                                        </div>
                                        <p class="mb-0 small">${comment.content}</p>
                                    </div>
                                </div>
                            `;
                            
                            commentsList.appendChild(commentElement);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            
            // Comment form submission
            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const postId = this.getAttribute('data-post-id');
                    const input = this.querySelector('input');
                    const content = input.value.trim();
                    
                    if (content === '') return;
                    
                    fetch('/post/' + postId + '/comment/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ content: content }),
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear input
                            input.value = '';
                            
                            // Reload comments
                            loadComments(postId);
                            
                            // Update comment count
                            const commentCountEl = document.querySelector(`.btn-comment[data-post-id="${postId}"] span`);
                            if (commentCountEl) {
                            commentCountEl.textContent = data.commentsCount;
                            }
                            
                            // Mettre à jour le compteur dans les statistiques
                            updatePostStats(postId, 'comments', data.commentsCount);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        });
    </script>
{% endblock %} 